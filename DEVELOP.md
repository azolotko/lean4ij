# Project and package structure

A brief description of current project and package structure

```
browser-infoview        : the frontend of external infoview
gradle                  : gradle wrapper
script                  : script that converts unicode to live templates
src/main/kotlin/lean4ij : main source of current implementation
├───actions             : actions (see Actions section in README.md)
├───infoview            : infoview implementation
│   └───external        : external infoview implementation
├───language            : currently textmate highlight and unicode live template
├───listeners           : a listener generated by intellij-plugin-template, not used
├───lsp                 : lsp client implementation
├───project             : project biz implementation
├───services            : a service generated by intellij-plugin-template, not used
└───util                : some utils
```

# LSP
currently the project is using [Lsp4ij](https://github.com/redhat-developer/lsp4ij) to connect lean4 lsp server.

For some document on lean4 lsp server, please check
- [src/Lean/Server](https://github.com/leanprover/lean4/tree/master/src/Lean/Server)

# Highlight

The basic syntax highlight adapts the textmate syntax files from [vscode-lean4/syntaxes/](https://raw.githubusercontent.com/leanprover/vscode-lean4/master/vscode-lean4/syntaxes/), using intelij platform sdk's textmate extension api and the implementation is at the class `Lean4TextMateBundleProvider`. 

The sematic syntax highlight is transparently handled by lsp4ij and the lsp server and hence there is no code for this. Nevertheless there is some discussion on zulip saying there is some hacky part here, check [Full BNF syntax?](https://leanprover.zulipchat.com/#narrow/stream/113489-new-members/topic/Full.20BNF.20syntax.3F)

# Unicode input

The unicode input is implemented via [live template](https://www.jetbrains.com/help/idea/using-live-templates.html). The template source is from [vscode-lean4/lean4-unicode-input/src/abbreviations.json](https://github.com/leanprover/vscode-lean4/blob/master/lean4-unicode-input/src/abbreviations.json) and using a script converting to intellij platform's format, the implement currently is at `Lean4Language.kt`.

# InfoView

There is two infoview implementations currently:
- the external infoview
- the swing infoview

## The external infoview
the external infoview is adapting [lean4-infoview](https://github.com/leanprover/vscode-lean4/tree/master/lean4-infoview). The frontend source code is in the folder `browser-infoview`. The api is bridged to editor via a websocket connection. Check `Route.kt` file for this. The external infoview can be opened in a web browser and using [JCEF](https://plugins.jetbrains.com/docs/intellij/jcef.html) embedding into the editor.
Currently, the code is still very badly organized for requiring further development.

## The swing infoview
the swing infoview is a raw infoview implemented using intellij platform's swing component.
Currently, the code is still very badly organized for requiring further development.
The entrance point for rendering is at `LeanFile.updateCaret` which call `LeanInfoViewWindowFactory.updateGoal` when all lsp call finish.



## Developing in Intellij Idea
(TODO this seems not work) Proxy issue (this should only happen in some specific region)
If the runPlugin task requires some proxy, do
```
ORG_GRADLE_PROJECT_systemProp.https.proxyHost=<ip>
ORG_GRADLE_PROJECT_systemProp.https.proxyPort=<port>
ORG_GRADLE_PROJECT_systemProp.https.nonProxyHosts=*.nonproxyrepos.com|localhost
```
in system environment. Replace the `<ip>` and `<port>` to real value.
ref: https://docs.gradle.org/current/userguide/project_properties.html

For first (and while require updating the frontend, run a `gradle buildBrowserInfoview` before run `runIde`)

# Ref

- Some threads in zulip during the developments:
  - [Would lsp server quit anomaly?](https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Would.20lsp.20server.20quit.20anomaly.3F)
  - [`elan which lake` downloads lean if it not exist](https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/.60elan.20which.20lake.60.20downloads.20lean.20if.20it.20not.20exist) This is why currently the way to find the toolchain is manually done
  - [integrating infoview app](https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/integrating.20infoview.20app)
  - [Lean 4 outside of VS Code](https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Lean.204.20outside.20of.20VS.20Code)
  - [lsp fileProgress and gerInteractiveGoals](https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/lsp.20fileProgress.20and.20gerInteractiveGoals)
  - [lsp getInteractiveGoals and subexprPos?](https://leanprover.zulipchat.com/#narrow/stream/113489-new-members/topic/lsp.20getInteractiveGoals.20and.20subexprPos.3F)
  - [Full BNF syntax?](https://leanprover.zulipchat.com/#narrow/stream/113489-new-members/topic/Full.20BNF.20syntax.3F)
  - [using lean4-infoview alone inside an external browser](https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/using.20lean4-infoview.20alone.20inside.20an.20external.20browser)
  - [✔ Lean LSP extensions](https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/.E2.9C.94.20Lean.20LSP.20extensions)



